/**
 * Bundled by jsDelivr using Rollup v2.79.1 and Terser v5.19.2.
 * Original file: /npm/cwise-compiler@1.1.3/compiler.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
import r from"../uniq@1.0.1/_esm.js";var e=r;function s(r,e,s){var a,n,o=r.length,t=e.arrayArgs.length,i=e.indexArgs.length>0,h=[],p=[],c=0,u=0;for(a=0;a<o;++a)p.push(["i",a,"=0"].join(""));for(n=0;n<t;++n)for(a=0;a<o;++a)u=c,c=r[a],0===a?p.push(["d",n,"s",a,"=t",n,"p",c].join("")):p.push(["d",n,"s",a,"=(t",n,"p",c,"-s",u,"*t",n,"p",u,")"].join(""));for(p.length>0&&h.push("var "+p.join(",")),a=o-1;a>=0;--a)c=r[a],h.push(["for(i",a,"=0;i",a,"<s",c,";++i",a,"){"].join(""));for(h.push(s),a=0;a<o;++a){for(u=c,c=r[a],n=0;n<t;++n)h.push(["p",n,"+=d",n,"s",a].join(""));i&&(a>0&&h.push(["index[",u,"]-=s",u].join("")),h.push(["++index[",c,"]"].join(""))),h.push("}")}return h.join("\n")}function a(r,e,s){for(var a=r.body,n=[],o=[],t=0;t<r.args.length;++t){var i=r.args[t];if(!(i.count<=0)){var h=new RegExp(i.name,"g"),p="",c=e.arrayArgs.indexOf(t);switch(e.argTypes[t]){case"offset":var u=e.offsetArgIndex.indexOf(t);c=e.offsetArgs[u].array,p="+q"+u;case"array":p="p"+c+p;var l="l"+t,g="a"+c;if(0===e.arrayBlockIndices[c])1===i.count?"generic"===s[c]?i.lvalue?(n.push(["var ",l,"=",g,".get(",p,")"].join("")),a=a.replace(h,l),o.push([g,".set(",p,",",l,")"].join(""))):a=a.replace(h,[g,".get(",p,")"].join("")):a=a.replace(h,[g,"[",p,"]"].join("")):"generic"===s[c]?(n.push(["var ",l,"=",g,".get(",p,")"].join("")),a=a.replace(h,l),i.lvalue&&o.push([g,".set(",p,",",l,")"].join(""))):(n.push(["var ",l,"=",g,"[",p,"]"].join("")),a=a.replace(h,l),i.lvalue&&o.push([g,"[",p,"]=",l].join("")));else{for(var f=[i.name],y=[p],d=0;d<Math.abs(e.arrayBlockIndices[c]);d++)f.push("\\s*\\[([^\\]]+)\\]"),y.push("$"+(d+1)+"*t"+c+"b"+d);if(h=new RegExp(f.join(""),"g"),p=y.join("+"),"generic"===s[c])throw new Error("cwise: Generic arrays not supported in combination with blocks!");a=a.replace(h,[g,"[",p,"]"].join(""))}break;case"scalar":a=a.replace(h,"Y"+e.scalarArgs.indexOf(t));break;case"index":a=a.replace(h,"index");break;case"shape":a=a.replace(h,"shape")}}}return[n.join("\n"),a,o.join("\n")].join("\n").trim()}function n(r){for(var e=new Array(r.length),s=!0,a=0;a<r.length;++a){var n=r[a],o=n.match(/\d+/);o=o?o[0]:"",0===n.charAt(0)?e[a]="u"+n.charAt(1)+o:e[a]=n.charAt(0)+o,a>0&&(s=s&&e[a]===e[a-1])}return s?e[0]:e.join("")}var o=function(r,o){for(var t=o[1].length-Math.abs(r.arrayBlockIndices[0])|0,i=new Array(r.arrayArgs.length),h=new Array(r.arrayArgs.length),p=0;p<r.arrayArgs.length;++p)h[p]=o[2*p],i[p]=o[2*p+1];var c=[],u=[],l=[],g=[],f=[];for(p=0;p<r.arrayArgs.length;++p){r.arrayBlockIndices[p]<0?(l.push(0),g.push(t),c.push(t),u.push(t+r.arrayBlockIndices[p])):(l.push(r.arrayBlockIndices[p]),g.push(r.arrayBlockIndices[p]+t),c.push(0),u.push(r.arrayBlockIndices[p]));for(var y=[],d=0;d<i[p].length;d++)l[p]<=i[p][d]&&i[p][d]<g[p]&&y.push(i[p][d]-l[p]);f.push(y)}var j=["SS"],w=["'use strict'"],A=[];for(d=0;d<t;++d)A.push(["s",d,"=SS[",d,"]"].join(""));for(p=0;p<r.arrayArgs.length;++p){j.push("a"+p),j.push("t"+p),j.push("p"+p);for(d=0;d<t;++d)A.push(["t",p,"p",d,"=t",p,"[",l[p]+d,"]"].join(""));for(d=0;d<Math.abs(r.arrayBlockIndices[p]);++d)A.push(["t",p,"b",d,"=t",p,"[",c[p]+d,"]"].join(""))}for(p=0;p<r.scalarArgs.length;++p)j.push("Y"+p);if(r.shapeArgs.length>0&&A.push("shape=SS.slice(0)"),r.indexArgs.length>0){var b=new Array(t);for(p=0;p<t;++p)b[p]="0";A.push(["index=[",b.join(","),"]"].join(""))}for(p=0;p<r.offsetArgs.length;++p){var v=r.offsetArgs[p],m=[];for(d=0;d<v.offset.length;++d)0!==v.offset[d]&&(1===v.offset[d]?m.push(["t",v.array,"p",d].join("")):m.push([v.offset[d],"*t",v.array,"p",d].join("")));0===m.length?A.push("q"+p+"=0"):A.push(["q",p,"=",m.join("+")].join(""))}var k=e([].concat(r.pre.thisVars).concat(r.body.thisVars).concat(r.post.thisVars));for((A=A.concat(k)).length>0&&w.push("var "+A.join(",")),p=0;p<r.arrayArgs.length;++p)w.push("p"+p+"|=0");r.pre.body.length>3&&w.push(a(r.pre,r,h));var x=a(r.body,r,h),I=function(r){for(var e=0,s=r[0].length;e<s;){for(var a=1;a<r.length;++a)if(r[a][e]!==r[0][e])return e;++e}return e}(f);I<t?w.push(function(r,e,a,n){for(var o=e.length,t=a.arrayArgs.length,i=a.blockSize,h=a.indexArgs.length>0,p=[],c=0;c<t;++c)p.push(["var offset",c,"=p",c].join(""));for(c=r;c<o;++c)p.push(["for(var j"+c+"=SS[",e[c],"]|0;j",c,">0;){"].join("")),p.push(["if(j",c,"<",i,"){"].join("")),p.push(["s",e[c],"=j",c].join("")),p.push(["j",c,"=0"].join("")),p.push(["}else{s",e[c],"=",i].join("")),p.push(["j",c,"-=",i,"}"].join("")),h&&p.push(["index[",e[c],"]=j",c].join(""));for(c=0;c<t;++c){for(var u=["offset"+c],l=r;l<o;++l)u.push(["j",l,"*t",c,"p",e[l]].join(""));p.push(["p",c,"=(",u.join("+"),")"].join(""))}for(p.push(s(e,a,n)),c=r;c<o;++c)p.push("}");return p.join("\n")}(I,f[0],r,x)):w.push(s(f[0],r,x)),r.post.body.length>3&&w.push(a(r.post,r,h)),r.debug&&console.log("-----Generated cwise routine for ",o,":\n"+w.join("\n")+"\n----------");var E=[r.funcName||"unnamed","_cwise_loop_",i[0].join("s"),"m",I,n(h)].join("");return new Function(["function ",E,"(",j.join(","),"){",w.join("\n"),"} return ",E].join(""))()};var t=function(r){var e=["'use strict'","var CACHED={}"],s=[],a=r.funcName+"_cwise_thunk";e.push(["return function ",a,"(",r.shimArgs.join(","),"){"].join(""));for(var n=[],t=[],i=[["array",r.arrayArgs[0],".shape.slice(",Math.max(0,r.arrayBlockIndices[0]),r.arrayBlockIndices[0]<0?","+r.arrayBlockIndices[0]+")":")"].join("")],h=[],p=[],c=0;c<r.arrayArgs.length;++c){var u=r.arrayArgs[c];s.push(["t",u,"=array",u,".dtype,","r",u,"=array",u,".order"].join("")),n.push("t"+u),n.push("r"+u),t.push("t"+u),t.push("r"+u+".join()"),i.push("array"+u+".data"),i.push("array"+u+".stride"),i.push("array"+u+".offset|0"),c>0&&(h.push("array"+r.arrayArgs[0]+".shape.length===array"+u+".shape.length+"+(Math.abs(r.arrayBlockIndices[0])-Math.abs(r.arrayBlockIndices[c]))),p.push("array"+r.arrayArgs[0]+".shape[shapeIndex+"+Math.max(0,r.arrayBlockIndices[0])+"]===array"+u+".shape[shapeIndex+"+Math.max(0,r.arrayBlockIndices[c])+"]"))}for(r.arrayArgs.length>1&&(e.push("if (!("+h.join(" && ")+")) throw new Error('cwise: Arrays do not all have the same dimensionality!')"),e.push("for(var shapeIndex=array"+r.arrayArgs[0]+".shape.length-"+Math.abs(r.arrayBlockIndices[0])+"; shapeIndex--\x3e0;) {"),e.push("if (!("+p.join(" && ")+")) throw new Error('cwise: Arrays do not all have the same shape!')"),e.push("}")),c=0;c<r.scalarArgs.length;++c)i.push("scalar"+r.scalarArgs[c]);return s.push(["type=[",t.join(","),"].join()"].join("")),s.push("proc=CACHED[type]"),e.push("var "+s.join(",")),e.push(["if(!proc){","CACHED[type]=proc=compile([",n.join(","),"])}","return proc(",i.join(","),")}"].join("")),r.debug&&console.log("-----Generated thunk:\n"+e.join("\n")+"\n----------"),new Function("compile",e.join("\n"))(o.bind(void 0,r))};function i(){this.argTypes=[],this.shimArgs=[],this.arrayArgs=[],this.arrayBlockIndices=[],this.scalarArgs=[],this.offsetArgs=[],this.offsetArgIndex=[],this.indexArgs=[],this.shapeArgs=[],this.funcName="",this.pre=null,this.body=null,this.post=null,this.debug=!1}var h=function(r){var e=new i;e.pre=r.pre,e.body=r.body,e.post=r.post;var s=r.args.slice(0);e.argTypes=s;for(var a=0;a<s.length;++a){var n=s[a];if("array"===n||"object"==typeof n&&n.blockIndices){if(e.argTypes[a]="array",e.arrayArgs.push(a),e.arrayBlockIndices.push(n.blockIndices?n.blockIndices:0),e.shimArgs.push("array"+a),a<e.pre.args.length&&e.pre.args[a].count>0)throw new Error("cwise: pre() block may not reference array args");if(a<e.post.args.length&&e.post.args[a].count>0)throw new Error("cwise: post() block may not reference array args")}else if("scalar"===n)e.scalarArgs.push(a),e.shimArgs.push("scalar"+a);else if("index"===n){if(e.indexArgs.push(a),a<e.pre.args.length&&e.pre.args[a].count>0)throw new Error("cwise: pre() block may not reference array index");if(a<e.body.args.length&&e.body.args[a].lvalue)throw new Error("cwise: body() block may not write to array index");if(a<e.post.args.length&&e.post.args[a].count>0)throw new Error("cwise: post() block may not reference array index")}else if("shape"===n){if(e.shapeArgs.push(a),a<e.pre.args.length&&e.pre.args[a].lvalue)throw new Error("cwise: pre() block may not write to array shape");if(a<e.body.args.length&&e.body.args[a].lvalue)throw new Error("cwise: body() block may not write to array shape");if(a<e.post.args.length&&e.post.args[a].lvalue)throw new Error("cwise: post() block may not write to array shape")}else{if("object"!=typeof n||!n.offset)throw new Error("cwise: Unknown argument type "+s[a]);e.argTypes[a]="offset",e.offsetArgs.push({array:n.array,offset:n.offset}),e.offsetArgIndex.push(a)}}if(e.arrayArgs.length<=0)throw new Error("cwise: No array arguments specified");if(e.pre.args.length>s.length)throw new Error("cwise: Too many arguments in pre() block");if(e.body.args.length>s.length)throw new Error("cwise: Too many arguments in body() block");if(e.post.args.length>s.length)throw new Error("cwise: Too many arguments in post() block");return e.debug=!!r.printCode||!!r.debug,e.funcName=r.funcName||"cwise",e.blockSize=r.blockSize||64,t(e)};export{h as default};
